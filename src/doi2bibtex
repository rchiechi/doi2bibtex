#!/usr/bin/env python3

import opts
import util
import bibtex
import interact
import output
from colorama import init, Fore, Style

# Setup colors
init(autoreset=True)

args = opts.getopts()

logger = util.getlogger('doi2bib', root=True, loglevel=args.loglevel)

logger.debug("Debug logging enabled.")

# journals = util.loadabbreviations(args.database,
#                                   custom=args.custom,
#                                   refresh=args.refresh)


if args.bibtexdb:
    library = bibtex.read(args.bibtexdb)
    logger.debug(f"Parsed {len(library.entries)} from {args.bibtexdb}.")
else:
    library = bibtex.read('')

dois = list(args.dois)
if args.doifile:
    dois += util.doifinder(args.doifile)
    logger.debug(dois)

added = 0
for doi in dois:
    result = util.doitobibtex(doi)
    if result:
        library.add(bibtex.read(result).entries)
        logger.debug(f"Added {doi} to library")
        added += 1

getattr(output, args.outputmode)(library, args)
# if args.outputmode == 'bibtexdb':
#     output.bibtexdb(library, args)
# if args.outputmode == 'clipboard':
#     output.clipboard(library, args)